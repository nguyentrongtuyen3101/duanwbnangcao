@model doanwebnangcao.Models.User

@{
    ViewBag.Title = "trangcanhan";
}
<style>
    /* Thêm vào file app.css hoặc một file CSS khác */
    [class*="System.Collec"], [class*="o.Models.t"] {
        display: none !important;
    }
</style>
<main>
    <div class="app-content">
        <!--====== Section 1 ======-->
        <div class="u-s-p-y-60">
            <!--====== Section Content ======-->
            <div class="section__content">
                <div class="container">
                    <div class="breadcrumb">
                        <div class="breadcrumb__wrap">
                            <ul class="breadcrumb__list">
                                <li class="has-separator">
                                    <a href="@Url.Action("trangchu", "trangchu")">Home</a>
                                </li>
                                <li class="is-marked">
                                    <a href="@Url.Action("trangcanhan", "profile")">My Account</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--====== End - Section 1 ======-->
        <!--====== Section 2 ======-->
        <div class="u-s-p-b-60">
            <!--====== Section Content ======-->
            <div class="section__content">
                <div class="dash">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-3 col-md-12">
                                <!--====== Dashboard Features ======-->
                                <div class="dash__box dash__box--bg-white dash__box--shadow u-s-m-b-30">
                                    <div class="dash__pad-1">
                                        <span class="dash__text u-s-m-b-16">Hello, @(Model.FirstName != null ? Model.FirstName : "") @(Model.LastName != null ? Model.LastName : "")</span>
                                        <ul class="dash__f-list">
                                            <li>
                                                <a class="dash-active" href="@Url.Action("trangcanhan", "profile")">Manage My Account</a>
                                            </li>
                                            <li>
                                                <a href="@Url.Action("myprofile", "profile")">My Profile</a>
                                            </li>
                                            <li>
                                                <a href="@Url.Action("editaddress", "profile")">Address Book</a>
                                            </li>
                                          
                                            <li>
                                                <a href="@Url.Action("quanlydonhang", "muahang")">My Orders</a>
                                            </li>
                                            <li>
                                          
                                        </ul>
                                    </div>
                                </div>
                                <div class="dash__box dash__box--bg-white dash__box--shadow dash__box--w">
                                    <div class="dash__pad-1">
                                        <ul class="dash__w-list">
                                            <li>
                                                <div class="dash__w-wrap">
                                                    <span class="dash__w-icon dash__w-icon-style-1"><i class="fas fa-cart-arrow-down"></i></span>
                                                    <span class="dash__w-text">@(Model.Orders != null ? Model.Orders.Count.ToString() : "0")</span>
                                                    <span class="dash__w-name">Orders Placed</span>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dash__w-wrap">
                                                    <span class="dash__w-icon dash__w-icon-style-2"><i class="fas fa-times"></i></span>
                                                    <span class="dash__w-text">0</span>
                                                    <span class="dash__w-name">Cancel Orders</span>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dash__w-wrap">
                                                    <span class="dash__w-icon dash__w-icon-style-3"><i class="far fa-heart"></i></span>
                                                    <span class="dash__w-text">@(Model.Wishlists != null ? Model.Wishlists.Count.ToString() : "0")</span>
                                                    <span class="dash__w-name">Wishlist</span>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <!--====== End - Dashboard Features ======-->
                            </div>
                            <div class="col-lg-9 col-md-12">
                                <div class="dash__box dash__box--shadow dash__box--radius dash__box--bg-white u-s-m-b-30">
                                    <div class="dash__pad-2">
                                        <h1 class="dash__h1 u-s-m-b-14">Manage My Account</h1>
                                        <span class="dash__text u-s-m-b-30">From your My Account Dashboard you have the ability to view a snapshot of your recent account activity and update your account information. Select a link below to view or edit information.</span>
                                        <div class="row">
                                            <div class="col-lg-6 u-s-m-b-30">
                                                <div class="dash__box dash__box--bg-grey dash__box--shadow-2 u-h-100">
                                                    <div class="dash__pad-3">
                                                        <h2 class="dash__h2 u-s-m-b-8">PERSONAL PROFILE</h2>
                                                        <div class="dash__link dash__link--secondary u-s-m-b-8">
                                                            <a href="@Url.Action("editprofile", "profile")">Edit</a>
                                                        </div>
                                                        <span class="dash__text">@(Model.FirstName != null ? Model.FirstName : "") @(Model.LastName != null ? Model.LastName : "")</span>
                                                        <span class="dash__text">@(Model.Email != null ? Model.Email : "")</span>
                                                        <div class="dash__link dash__link--secondary u-s-m-t-8">
                                                            <a data-modal="modal" data-modal-id="#dash-newsletter">Subscribe Newsletter</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-6 u-s-m-b-30">
                                                <div class="dash__box dash__box--bg-grey dash__box--shadow-2 u-h-100">
                                                    <div class="dash__pad-3">
                                                        <h2 class="dash__h2 u-s-m-b-8">ADDRESS BOOK</h2>
                                                        <span class="dash__text-2 u-s-m-b-8">Default Shipping Address</span>
                                                        <div class="dash__link dash__link--secondary u-s-m-b-8">
                                                            <a href="@Url.Action("editaddress", "profile")">Edit</a>
                                                        </div>
                                                        <span class="dash__text">4247 Ashford Drive Virginia - VA-20006 - USA</span>
                                                        <span class="dash__text">(+0) 900901904</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="dash__box dash__box--shadow dash__box--bg-white dash__box--radius">
                                    <h2 class="dash__h2 u-s-p-xy-20">RECENT ORDERS</h2>
                                    <div class="dash__table-wrap gl-scroll">
                                        <table class="dash__table">
                                            <thead>
                                                <tr>
                                                    <th>Order #</th>
                                                    <th>Placed On</th>
                                                    <th>Items</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (Model.Orders != null && Model.Orders.Any())
                                                {
                                                    foreach (var order in Model.Orders.OrderByDescending(o => o.OrderDate).Take(5)) // Giới hạn 5 đơn hàng gần đây nhất
                                                    {
                                                        <tr>
                                                            <td>@order.Id</td>
                                                            <td>@order.OrderDate.ToString("dd/MM/yyyy")</td>
                                                            <td>
                                                                @if (order.OrderDetails != null && order.OrderDetails.Any())
                                                                {
                                                                    foreach (var detail in order.OrderDetails.Take(1)) // Chỉ lấy 1 sản phẩm để hiển thị
                                                                    {
                                                                        var variant = detail.ProductVariant;
                                                                        var product = (variant != null) ? variant.Product : null;
                                                                        string imageUrl = (variant != null) ? variant.VariantImageUrl : null; // Ưu tiên ảnh của biến thể

                                                                        // Nếu biến thể không có ảnh, lấy ảnh từ sản phẩm
                                                                        if (string.IsNullOrEmpty(imageUrl) && product != null)
                                                                        {
                                                                            imageUrl = product.ImageUrl;
                                                                        }

                                                                        // Nếu có ProductImages, ưu tiên lấy ảnh chính (IsMain = true)
                                                                        if (variant != null && variant.ProductImages != null && variant.ProductImages.Any())
                                                                        {
                                                                            var mainImage = variant.ProductImages.FirstOrDefault(img => img.IsMain);
                                                                            if (mainImage != null)
                                                                            {
                                                                                imageUrl = mainImage.ImageUrl;
                                                                            }
                                                                            else
                                                                            {
                                                                                imageUrl = variant.ProductImages.First().ImageUrl;
                                                                            }
                                                                        }

                                                                        // Nếu không có ảnh, sử dụng ảnh mặc định
                                                                        if (string.IsNullOrEmpty(imageUrl))
                                                                        {
                                                                            imageUrl = "~/pep/images/product/electronic/product3.jpg"; // Ảnh mặc định
                                                                        }

                                                                        <div class="dash__table-img-wrap">
                                                                            <img class="u-img-fluid" src="@imageUrl" alt="@((product != null) ? product.Name : "Product Image")">
                                                                        </div>
                                                                        <div class="dash__table-item-info">
                                                                            <span class="dash__text">@((product != null) ? product.Name : "Unknown Product")</span>
                                                                            <span class="dash__text">Quantity: @detail.Quantity</span>
                                                                        </div>
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    <span>No items in this order.</span>
                                                                }
                                                            </td>
                                                            <td>
                                                                <div class="dash__table-total">
                                                                    <span>$@order.TotalAmount</span>
                                                                    <div class="dash__link dash__link--brand">
                                                                        <a href="@Url.Action("quanlychitietdonhang", "muahang", new { orderId = order.Id })">MANAGE</a>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr>
                                                        <td colspan="4">No orders found.</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--====== End - Section Content ======-->
        </div>
        <!--====== End - Section 2 ======-->
    </div>
    <!--====== End - App Content ======-->
</main>